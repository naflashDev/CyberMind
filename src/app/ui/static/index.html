<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>CYBERMIND</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 220px;
      background: #111827;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 16px;
      box-sizing: border-box;
      transition: width 0.2s ease, transform 0.2s ease;
    }

    .sidebar.hidden {
      width: 0;
      padding: 16px 0;
      transform: translateX(-100%);
    }

    .sidebar h1 {
      font-size: 18px;
      margin: 0 0 16px;
      color: #f9fafb;
      white-space: nowrap;
    }

    .nav-button {
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: none;
      background: #1f2937;
      color: inherit;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
      white-space: nowrap;
    }

    .nav-button:hover {
      background: #374151;
    }

    .nav-button.active {
      background: #2563eb;
      color: #f9fafb;
    }

    /* Toggle button (always visible) */
    .toggle-wrapper {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      background: #111827;
    }

    .toggle-sidebar {
      background: #111827;
      color: #e5e7eb;
      border: none;
      padding: 8px 6px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 0 4px 4px 0;
    }

    .main {
      flex: 1;
      background: #f3f4f6;
      display: flex;
      flex-direction: column;
    }

    .main-content {
      flex: 1;
      padding: 0;
      overflow: hidden;
      position: relative;
    }

    .view {
      width: 100%;
      height: 100%;
      display: none;
    }

    .view.active {
      display: block;
    }


    .embed-frame {
      width: 100%;
      height: 100%;
      border: none;
      background: #ffffff;
    }

    /* LLM console styles: full-size */
    #view-llm {
      background: #0d1117;
      color: #e6edf3;
      padding: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    #llm-panel {
      margin: 0;
      width: 100%;
      height: 100%;
      background-color: #161b22;
      border-radius: 0;
      border: 1px solid #30363d;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    #llm-panel h2 {
      margin: 0 0 4px 0;
      font-size: 18px;
    }

    #llm-panel p {
      margin: 0 0 12px 0;
      font-size: 13px;
      color: #ffffff;
    }

    #llm-messages {
      flex: 1;
      height: auto;
      overflow-y: auto;
      padding: 8px;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #36465f;
      font-size: 13px;
      line-height: 1.4;
      box-sizing: border-box;
    }

    #llm-input-row {
      display: flex;
      margin-top: 10px;
      gap: 8px;
    }

    #llm-prompt {
      flex: 1;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #555;
      background-color: #101010;
      color: #f1f1f1;
    }

    #llm-prompt::placeholder {
      color: #6e7681;
    }

    #llm-send-btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      background: #238636;
      color: #fff;
      cursor: pointer;
    }

    #llm-send-btn:hover {
      background: #2ea043;
    }

    /* Chat bubbles */
    .user-message {
      text-align: right;
      margin-bottom: 4px;
      font-size: 15px;
    }

    .user-message span {
      display: inline-block;
      background: #1d4ed8;
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .bot-message {
      text-align: left;
      margin-bottom: 8px;
    }

    .bot-message span {
      display: inline-block;
      background: #3a548a;
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }

    /* Controllers pane (FastAPI) - dark theme */
    .controllers-pane {
      width: 280px;
      background: #0b1220; /* dark background */
      color: #e6eef8;
      border-right: 1px solid #111827;
      padding: 12px;
      box-sizing: border-box;
      overflow: auto;
    }

    .controllers-pane h3 {
      margin-top: 0;
      color: #e6eef8;
    }

    .controller-section {
      margin-bottom: 8px;
      border-radius: 6px;
      overflow: hidden;
      background: transparent;
    }

    .controller-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: transparent;
      color: #dbeafe;
      font-weight: 600;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }

    .controller-header .toggle-icon {
      font-size: 12px;
      color: #9ca3af;
      margin-left: 8px;
    }

    .ops-container {
      margin-top: 6px;
      display: block;
    }

    .controller-section.collapsed .ops-container {
      display: none;
    }

    .op-btn {
      display: block;
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
      color: #e6eef8;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
    }

    .op-btn:hover {
      background: rgba(255,255,255,0.04);
    }

    .op-btn.active {
      background: #2563eb; /* blue highlight */
      color: #f8fafc;
      border-color: rgba(37,99,235,0.8);
    }

    /* Response rendering styles */
    #op-result {
      display: none;
      background:#0b1220;
      color:#e6eef8;
      padding:12px;
      border-radius:6px;
      box-sizing:border-box;
      white-space:normal;
    }

    #op-result .response-box {
      font-size:13px;
      line-height:1.45;
    }

    #op-result .response-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:12px;
    }

    #op-result .response-meta { color:#9aa6b2; font-size:12px }
    #op-result .response-key { color:#93c5fd; font-weight:600; margin-right:6px }
    #op-result .response-value { color:#e6eef8 }
    #op-result .response-list { margin:0; padding-left:18px }
    #op-result .response-error { color:#fca5a5 }
    #op-result pre { background:transparent; color:inherit; border:0; padding:0; margin:0; white-space:pre-wrap }

    .copy-json-btn {
      background: #0b1220;
      color: #93c5fd;
      border: 1px solid rgba(147,197,253,0.15);
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .copy-json-btn:hover { background:#071122 }

    .toast {
      position:fixed;
      right:20px;
      bottom:20px;
      background:#111827;
      color:#e6eef8;
      padding:8px 12px;
      border-radius:6px;
      box-shadow:0 6px 18px rgba(2,6,23,0.6);
      opacity:0;
      transition:opacity .18s ease;
      z-index:9999;
    }

    .toast.show { opacity:1 }

    /* Two-column response layout */
    .response-two-col { display:flex; gap:12px; align-items:flex-start }
    .response-two-col .left-pane { flex:1; min-width:0 }
    .response-two-col .right-pane { width:420px; max-width:40%; box-sizing:border-box }

    .raw-box { background:#071025; border:1px solid rgba(255,255,255,0.03); padding:10px; border-radius:6px; }
    .raw-box .raw-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
    .raw-box pre { max-height:480px; overflow:auto; background:transparent; color:inherit; white-space:pre-wrap }

    /* Panel collapse behaviour */
    .panel { border-radius:6px; overflow:hidden }
    .panel .panel-body { transition: max-height 0.18s ease; }
    .panel.collapsed .panel-body { display:none }
    .panel-toggle { background:transparent; border:0; color:#9aa6b2; cursor:pointer; font-size:14px; padding:4px 8px; }

  </style>

  <!-- Markdown parser (marked) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- [web:67] -->
</head>

<body>
  <!-- Botón fijo para mostrar/ocultar la sidebar -->
  <div class="toggle-wrapper">
    <button class="toggle-sidebar" id="btn-toggle">&laquo;</button>
  </div>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <h1>CyberMind</h1>
    <button class="nav-button active" data-view="fastapi" id="btn-fastapi">Operaciones FastAPI</button>
    <button class="nav-button" data-view="datos" id="btn-datos">Datos</button>
    <button class="nav-button" data-view="tiny" id="btn-tiny">Noticias Tiny</button>
    <button class="nav-button" data-view="llm" id="btn-llm">CyberSentinel IA</button>

  </aside>

  <!-- MAIN -->
  <div class="main">
    <div class="main-content">
      <!-- Vista: FastAPI - Operaciones de los controllers -->
      <div class="view active" id="view-fastapi">
        <div style="display:flex; height:100%;">
          <!-- Left: controllers list inside the fastapi view -->
          <div class="controllers-pane">
            <h3>Services</h3>
            <div id="controllers-list"></div>
          </div>

          <!-- Right: operation form and result -->
          <div style="flex:1; padding:12px; box-sizing:border-box; display:flex; flex-direction:column;">
            <div style="margin-bottom:8px; display:flex; align-items:center; justify-content:space-between;">
              <h3 id="op-title" style="margin:0;">Seleccione una operación</h3>
              <div style="font-size:13px; color:#6b7280;">FastAPI API: <code>http://127.0.0.1:8000</code></div>
            </div>

            <div id="op-form" style="margin-bottom:12px;">
              <p style="color:#6b7280;">Seleccione una operación en la izquierda para ver los parámetros y ejecutarla.</p>
            </div>

            <div style="flex:1; overflow:auto;">
              <div id="op-result" style="display:none; background:#0b1220; color:#e6eef8; padding:12px; border-radius:6px; box-sizing:border-box;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista: Datos (OpenSearch en localhost:5601) -->
      <div class="view" id="view-datos">
        <iframe class="embed-frame" src="http://127.0.0.1:5601/"></iframe>
      </div>

      <!-- Vista: Noticias Tiny (Tiny RSS en 127.0.0.1:8280/tt-rss/) -->
      <div class="view" id="view-tiny">
        <iframe class="embed-frame" src="http://127.0.0.1:8280/tt-rss/"></iframe>
      </div>

      <!-- Vista LLM full-size -->
      <div class="view" id="view-llm">
        <div id="llm-panel">
          <h2>LLM Console (Cyberintelligence)</h2>
          <p>Interactúa con el modelo local (llama3 en Ollama) para consultar CVE y noticias procesadas.</p>

          <div id="llm-messages"></div>

          <div id="llm-input-row">
            <input id="llm-prompt" type="text"
              placeholder="Escribe tu pregunta al LLM (por ejemplo, explica un CVE o resume una noticia)..." />
            <button id="llm-send-btn">Enviar</button>
          </div>
        </div>
      </div>
      <!-- Vista: Estado del sistema -->
      <div class="view" id="view-status">
        <div style="padding:16px; box-sizing:border-box; height:100%; display:flex; flex-direction:column; gap:12px;">
          <h2>Estado del sistema</h2>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="btn-refresh-status-view" style="padding:8px 12px; border-radius:6px; border:none; background:#2563eb; color:#fff; cursor:pointer;">Actualizar</button>
            <div id="status-summary" style="color:#9aa6b2;">Cargando estado...</div>
          </div>
          <div style="flex:1; overflow:auto;">
            <pre id="status-json" style="background:#0b1220; color:#e6eef8; padding:12px; border-radius:6px; white-space:pre-wrap;">Cargando...</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const btnToggle = document.getElementById("btn-toggle");

    const buttons = document.querySelectorAll(".nav-button");
    const views = {
      fastapi: document.getElementById("view-fastapi"),
      datos: document.getElementById("view-datos"),
      tiny: document.getElementById("view-tiny"),
      llm: document.getElementById("view-llm"),
      status: document.getElementById("view-status"),
    };

    function activateView(viewName) {
      // desactiva todos los botones
      buttons.forEach(btn => btn.classList.remove("active"));
      // activa el botón correspondiente
      const activeBtn = document.querySelector(`.nav-button[data-view="${viewName}"]`);
      if (activeBtn) activeBtn.classList.add("active");

      // oculta todas las vistas
      Object.values(views).forEach(v => v.classList.remove("active"));
      // muestra solo la seleccionada
      if (views[viewName]) views[viewName].classList.add("active");

      // no fixed status bar to manage (removed)
    }

    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        const view = btn.dataset.view;
        activateView(view);
      });
    });

    btnToggle.addEventListener("click", () => {
      const hidden = sidebar.classList.toggle("hidden");
      btnToggle.innerHTML = hidden ? "☰" : "«";
    });

    // vista inicial
    activateView("fastapi");
  </script>

  <!-- FastAPI operations panel script -->
  <script>
    (function () {
      const API_BASE = window.__CYBERMIND_API_BASE__ || "http://127.0.0.1:8000";

      // Known controller operations (hardcoded from server routes)
      const controllers = {
        "Scrapy": [
          { id: "scrape-news", title: "Scrape News", method: "GET", path: "/newsSpider/scrape-news", params: [], desc: "Extrae noticias desde las fuentes configuradas y las normaliza." },
          { id: "start-google-alerts", title: "Start Google Alerts", method: "GET", path: "/newsSpider/start-google-alerts", params: [], desc: "Inicia la recolección de alertas de Google configuradas." },
          { id: "save-feed-google-alerts", title: "Save Feed Google Alerts", method: "POST", path: "/newsSpider/save-feed-google-alerts", params: [{name: "link", type: "text", placeholder: "URL o texto del feed"}], desc: "Guarda un feed (o URL) de Google Alerts en la base de datos." },
          { id: "scrapy-google-dk-feeds", title: "Scrapy Google DK Feeds", method: "GET", path: "/newsSpider/scrapy/google-dk/feeds", params: [], desc: "Rastrea y lista feeds encontrados para Google DK (feeds)." },
          { id: "scrapy-google-dk-news", title: "Scrapy Google DK News", method: "GET", path: "/newsSpider/scrapy/google-dk/news", params: [], desc: "Rastrea artículos/noticias desde Google DK." }
        ],
        "SpaCy": [
          { id: "start-spacy", title: "Start SpaCy", method: "GET", path: "/start-spacy", params: [], desc: "Inicia o carga el pipeline de SpaCy para procesamiento de texto." }
        ],
        "Tiny": [
          { id: "search-and-insert-rss", title: "Search and Insert RSS", method: "GET", path: "/postgre-ttrss/search-and-insert-rss", params: [{name: "link", type: "text", placeholder: "consulta (opcional)"}], desc: "Busca elementos RSS por consulta e inserta los nuevos en TinyRSS/Postgres." },
          { id: "feeds", title: "List Feeds", method: "GET", path: "/postgre-ttrss/feeds", params: [], desc: "Lista los feeds almacenados en la base de datos." }
        ],
        "Status": [
          { id: "system-status-op", title: "System Status", method: "GET", path: "/status", params: [], desc: "Muestra el estado de la infraestructura, UI y workers en ejecución." }
        ]
      };

      const controllersList = document.getElementById("controllers-list");
      const opTitle = document.getElementById("op-title");
      const opForm = document.getElementById("op-form");
      const opResult = document.getElementById("op-result");

      function renderControllers() {
        controllersList.innerHTML = "";
        Object.keys(controllers).forEach(name => {
          const wrapper = document.createElement("div");
          wrapper.className = "controller-section";

          // header with collapse toggle
          const headerBtn = document.createElement("button");
          headerBtn.className = "controller-header";
          headerBtn.type = "button";
          headerBtn.innerHTML = `<span>${name}</span><span class="toggle-icon">▾</span>`;
          headerBtn.addEventListener("click", () => {
            wrapper.classList.toggle("collapsed");
            const icon = headerBtn.querySelector('.toggle-icon');
            if (icon) icon.textContent = wrapper.classList.contains('collapsed') ? '▸' : '▾';
          });
          wrapper.appendChild(headerBtn);

          const opsContainer = document.createElement("div");
          opsContainer.className = "ops-container";

          controllers[name].forEach(op => {
            const opBtn = document.createElement("button");
            opBtn.className = "op-btn";
            opBtn.textContent = op.title;
            opBtn.type = "button";
            opBtn.addEventListener("click", () => {
              // set active visual state for buttons
              document.querySelectorAll('.op-btn').forEach(b => b.classList.remove('active'));
              opBtn.classList.add('active');
              selectOperation(name, op, opBtn);
            });
            opsContainer.appendChild(opBtn);
          });

          wrapper.appendChild(opsContainer);
          controllersList.appendChild(wrapper);
        });
      }

      function selectOperation(controllerName, op, btnEl) {
        opTitle.textContent = controllerName + " — " + op.title + " (" + op.method + ")";
        renderForm(op);
        // Hide the generic result area for the status operation (we show a custom panel)
        const opResultEl = document.getElementById('op-result');
        if (op.path === '/status') {
          if (opResultEl) opResultEl.style.display = 'none';
        } else {
          if (opResultEl) { opResultEl.style.display = 'block'; opResultEl.textContent = 'Respuesta aquí...'; }
        }
      }

      function renderForm(op) {
        opForm.innerHTML = "";
        const info = document.createElement("div");
        info.style.marginBottom = "8px";
        info.style.color = "#cbd5e1";
        // Show method and a short description (no public path)
        const methodEl = document.createElement('strong');
        methodEl.textContent = op.method;
        info.appendChild(methodEl);
        if (op.desc) {
          const descEl = document.createElement('div');
          descEl.style.color = '#9aa6b2';
          descEl.style.fontSize = '13px';
          descEl.style.marginTop = '6px';
          descEl.textContent = op.desc;
          info.appendChild(descEl);
        }
        opForm.appendChild(info);

        const form = document.createElement("form");
        form.onsubmit = async (e) => {
          e.preventDefault();
          await submitOperation(op, new FormData(form));
        };

        // Special-case UI for the /status operation: show a prettier panel inside the
        // FastAPI operations area (summary + JSON + refresh button).
        if (op.path === "/status") {
          const panel = document.createElement('div');
          panel.style.display = 'flex';
          panel.style.flexDirection = 'column';
          panel.style.gap = '8px';

          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '8px';

          const refreshBtn = document.createElement('button');
          refreshBtn.type = 'button';
          refreshBtn.textContent = 'Actualizar estado';
          refreshBtn.style.padding = '6px 10px';
          refreshBtn.style.borderRadius = '6px';
          refreshBtn.style.border = 'none';
          refreshBtn.style.background = '#2563eb';
          refreshBtn.style.color = '#fff';
          refreshBtn.style.cursor = 'pointer';

          row.appendChild(refreshBtn);

          const box = document.createElement('div');
          box.id = 'op-status-box';
          box.style.background = '#0b1220';
          box.style.color = '#e6eef8';
          box.style.padding = '12px';
          box.style.borderRadius = '6px';
          box.style.boxSizing = 'border-box';
          box.innerHTML = '<div>Cargando...</div>';

          panel.appendChild(row);
          panel.appendChild(box);
          opForm.appendChild(panel);

          // Enhanced status + worker control
          async function fetchForOp() {
            try {
              const resp = await fetch((window.__CYBERMIND_API_BASE__ || 'http://127.0.0.1:8000') + '/status');
              if (!resp.ok) throw new Error('HTTP ' + resp.status);
              const j = await resp.json();
              const workers = j.workers || {};

              // build header info
              const parts = [];
              parts.push(`<div style="margin-bottom:8px;"><strong>Infra:</strong> ${j.infra_ready ? '<span style="color:#86efac">OK</span>' : '<span style="color:#fca5a5">NO</span>'}${j.infra_error ? ` &nbsp; <em style=\"color:#fca5a5\">${j.infra_error}</em>` : ''}</div>`);
              parts.push(`<div style="margin-bottom:8px;"><strong>UI initialized:</strong> ${j.ui_initialized ? '<span style="color:#86efac">sí</span>' : '<span style="color:#fca5a5">no</span>'}</div>`);

              // Workers control list
              parts.push('<div style="margin-bottom:6px;"><strong>Workers</strong></div>');
              parts.push('<div id="workers-control-list" style="display:flex;flex-direction:column;gap:8px;">');
              for (const [name, val] of Object.entries(workers)) {
                const status = val ? '<span style="color:#86efac">running</span>' : '<span style="color:#fca5a5">stopped</span>';
                const btnStyle = val ? 'background:#ef4444;color:#fff' : 'background:#10b981;color:#fff';
                const btnText = val ? 'Stop' : 'Activate';
                parts.push(`<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                  <div style="display:flex;flex-direction:column;">
                    <div style="font-weight:600">${name}</div>
                    <div style="font-size:12px;color:#9aa6b2">Status: ${status}</div>
                  </div>
                  <div>
                    <button data-worker-toggle="${name}" data-enabled="${val}" style="padding:8px 10px;border-radius:6px;border:none;cursor:pointer;${btnStyle}">${btnText}</button>
                  </div>
                </div>`);
              }
              parts.push('</div>');

              document.getElementById('op-status-box').innerHTML = parts.join('');
              // notify user that panel updated
              try { showToast('Panel de estado actualizado'); } catch (e) {}
              // attach handlers for single toggle buttons
              const toggleBtns = document.querySelectorAll('#op-status-box button[data-worker-toggle]');
              toggleBtns.forEach(btn => {
                btn.addEventListener('click', async () => {
                  const name = btn.dataset.workerToggle;
                  const enabled = btn.dataset.enabled === 'true' || btn.dataset.enabled === 'True';
                  const newEnabled = !enabled;
                  // Optimistic UI: disable button until response
                  const oldText = btn.textContent;
                  btn.disabled = true;
                  try {
                    const p = await fetch((window.__CYBERMIND_API_BASE__ || 'http://127.0.0.1:8000') + '/workers/' + encodeURIComponent(name), {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ enabled: newEnabled })
                    });
                    if (!p.ok) throw new Error('HTTP ' + p.status);
                    showToast((newEnabled ? 'Activated' : 'Stopped') + ' ' + name);
                    // refresh status after change
                    setTimeout(fetchForOp, 300);
                  } catch (err) {
                    showToast('Error toggling worker: ' + String(err));
                    btn.disabled = false;
                    btn.textContent = oldText;
                  }
                });
              });

            } catch (err) {
              box.innerHTML = `<div style="color:#fca5a5">Error: ${String(err)}</div>`;
            }
          }

          refreshBtn.addEventListener('click', fetchForOp);
          // initial fetch for the panel
          fetchForOp();
          // listen for manual status updates triggered elsewhere
          try { window.addEventListener('status-updated', fetchForOp); } catch (e) {}
          // periodic refresh every 10s while panel is open
          let statusInterval = setInterval(() => {
            const boxEl = document.getElementById('op-status-box');
            if (!boxEl) return;
            // only refresh if panel is visible (user is on FastAPI view and status op selected)
            fetchForOp();
          }, 10000);
          return;
        }

        // params
        if (op.params && op.params.length) {
          op.params.forEach(p => {
            const label = document.createElement("label");
            label.style.display = "block";
            label.style.marginBottom = "6px";
            label.innerHTML = `<div style='font-size:13px;color:#cbd5e1;margin-bottom:4px;'>${p.name}</div>`;

            const input = document.createElement("input");
            input.name = p.name;
            input.placeholder = p.placeholder || "";
            input.style.width = "100%";
            input.style.padding = "8px";
            input.style.boxSizing = "border-box";
            input.style.marginBottom = "6px";
            label.appendChild(input);
            form.appendChild(label);
          });
        }

        const submit = document.createElement("button");
        submit.textContent = "Ejecutar";
        submit.type = "submit";
        submit.className = "exec-btn";
        submit.style.padding = "8px 12px";
        submit.style.background = "#2563eb";
        submit.style.color = "#fff";
        submit.style.border = "none";
        submit.style.borderRadius = "6px";
        submit.style.cursor = "pointer";

        form.appendChild(submit);
        opForm.appendChild(form);
      }

      // Utility: escape HTML
      function escapeHtml(unsafe) {
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Small toast helper
      function showToast(msg, ms = 1800) {
        try {
          const t = document.createElement('div');
          t.className = 'toast';
          t.textContent = msg;
          document.body.appendChild(t);
          // force reflow to allow transition
          void t.offsetWidth;
          t.classList.add('show');
          setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => t.remove(), 200);
          }, ms);
        } catch (e) {
          console.log('toast', e);
        }
      }

      // Render JSON/object values into a compact, readable HTML representation
      function renderResponse(obj, status) {
        // Render a friendly, non-JSON-first representation.
        function renderFriendly(value, depth = 0) {
          if (value === null) return `<span class="response-value">(nulo)</span>`;
          const t = typeof value;
          if (t === 'string' || t === 'number' || t === 'boolean') {
            return `<span class="response-value">${escapeHtml(String(value))}</span>`;
          }
          if (Array.isArray(value)) {
            if (value.length === 0) return `<span class="response-value">(vacío)</span>`;
            const items = value.slice(0, 200).map(it => `<li>${renderFriendly(it, depth+1)}</li>`).join('');
            const more = value.length > 200 ? `<li>... ${value.length - 200} más</li>` : '';
            return `<ul class="response-list">${items}${more}</ul>`;
          }
          if (t === 'object') {
            // protect from too deep recursion
            if (depth >= 2) {
              return `<details><summary>Objeto (mostrar JSON)</summary><pre>${escapeHtml(JSON.stringify(value, null, 2))}</pre></details>`;
            }
            const lines = Object.keys(value).map(k => {
              const v = value[k];
              // concise one-line for primitives
              if (v === null || typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean') {
                return `<div><span class="response-key">${escapeHtml(k)}:</span> ${renderFriendly(v, depth+1)}</div>`;
              }
              // arrays and objects will be nested
              return `<div style="margin-top:6px;"><span class="response-key">${escapeHtml(k)}:</span> ${renderFriendly(v, depth+1)}</div>`;
            }).join('');
            return `<div>${lines}</div>`;
          }
          return `<span class="response-value">${escapeHtml(String(value))}</span>`;
        }

        // build a panel with header (status + toggle) and body
        const panelHeader = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div class=\"response-meta\">Status: ${status || ''}</div><button class=\"panel-toggle\">▾</button></div>`;
        // If primitive, show simply
        if (obj === null || typeof obj !== 'object') {
          return `<div class="panel"><div class="panel-head">${panelHeader}</div><div class="panel-body">${renderFriendly(obj)}</div></div>`;
        }

        // Render top-level object as friendly text
        const friendlyHtml = renderFriendly(obj, 0);
        return `<div class="panel"><div class="panel-head">${panelHeader}</div><div class="panel-body">${friendlyHtml}</div></div>`;
      }
      
      // Render the raw JSON pane (visible) with copy button
      function renderRawJson(obj) {
        const jsonText = escapeHtml(JSON.stringify(obj, null, 2));
        const header = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;"><div class=\"response-meta\">JSON crudo</div><div><button class=\"panel-toggle\">▾</button> <button class=\"copy-json-btn\" type=\"button\">Copiar JSON</button></div></div>`;
        return `<div class="panel"><div class="panel-head">${header}</div><div class="panel-body"><div class="raw-box"><pre>${jsonText}</pre></div></div></div>`;
      }
      

      async function submitOperation(op, formData) {
        const url = API_BASE + op.path;
        // show response area and a loading hint
        opResult.style.display = 'block';
        opResult.innerHTML = `<div class="response-meta">Cargando...</div>`;

        try {
          let resp;
          if (op.method === "GET") {
            // append query params
            const params = new URLSearchParams();
            for (const [k, v] of formData.entries()) if (v) params.append(k, v);
            const final = params.toString() ? url + "?" + params.toString() : url;
            resp = await fetch(final);
          } else {
            const obj = {};
            for (const [k, v] of formData.entries()) obj[k] = v;
            resp = await fetch(url, {
              method: op.method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(obj)
            });
          }

          const text = await resp.text();
          // try parse json
          try {
            const j = JSON.parse(text);
                // render two-column view: friendly left, raw right (both panels include collapsible headers)
                opResult.innerHTML = `<div class="response-two-col"><div class="left-pane">${renderResponse(j, resp.status)}</div><div class="right-pane">${renderRawJson(j)}</div></div>`;
                // attach copy handler in the raw pane
                const copyBtn = opResult.querySelector('.right-pane .copy-json-btn');
                if (copyBtn) {
                  copyBtn.addEventListener('click', async () => {
                    try {
                      const textToCopy = JSON.stringify(j, null, 2);
                      if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(textToCopy);
                      } else {
                        const ta = document.createElement('textarea');
                        ta.value = textToCopy;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                      }
                      showToast('JSON copiado');
                    } catch (e) {
                      showToast('Error copiando JSON');
                    }
                  });
                }

                // attach collapse/expand handlers for both panels
                const toggles = opResult.querySelectorAll('.panel-toggle');
                toggles.forEach(t => {
                  t.addEventListener('click', () => {
                    const panel = t.closest('.panel');
                    if (!panel) return;
                    const body = panel.querySelector('.panel-body');
                    const isCollapsed = panel.classList.toggle('collapsed');
                    if (body) body.style.display = isCollapsed ? 'none' : '';
                    // update icon
                    t.textContent = isCollapsed ? '▸' : '▾';
                  });
                });
          } catch (e) {
            // not JSON: render as markdown if looks like markdown, otherwise as plain pre
            const t = text || '';
            const maybeMd = window.marked && (t.trim().startsWith('#') || t.includes('\n\n') || t.includes('```'));
            if (maybeMd) {
              try {
                opResult.innerHTML = `<div class="response-box">${window.marked.parse(t)}</div>`;
              } catch (me) {
                opResult.innerHTML = `<pre>${escapeHtml(t)}</pre>`;
              }
            } else {
              opResult.innerHTML = `<pre>${escapeHtml(t)}</pre>`;
            }
          }
          } catch (err) {
          opResult.innerHTML = `<div class="response-error">Error: ${escapeHtml(String(err))}</div>`;
        } finally {
          // Refresh global status summary and notify status panel (if open)
          try { if (typeof fetchStatus === 'function') fetchStatus(); } catch (e) {}
          try { window.dispatchEvent(new Event('status-updated')); } catch (e) {}
        }
      }

      // initial render
      renderControllers();
      // fetch system status and update UI
      async function fetchStatus() {
        try {
          const resp = await fetch((window.__CYBERMIND_API_BASE__ || 'http://127.0.0.1:8000') + '/status');
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const j = await resp.json();
          const ready = j.infra_ready ? 'OK' : 'NO';
          const uiInit = j.ui_initialized ? 'sí' : 'no';
          const workers = j.workers || {};
          const running = Object.entries(workers).filter(([k,v])=>v).map(([k])=>k).join(', ') || 'ninguno';
          const text = `Infra: ${ready} · UI init: ${uiInit} · Workers: ${running}`;
          // populate Status view if present
          const statusJson = document.getElementById('status-json');
          const statusSummary = document.getElementById('status-summary');
          if (statusJson) {
            try {
              statusJson.textContent = JSON.stringify(j, null, 2);
            } catch (e) {
              statusJson.textContent = String(j);
            }
          }
          if (statusSummary) {
            statusSummary.textContent = `Infra: ${j.infra_ready ? 'OK' : 'NO'} · UI init: ${j.ui_initialized ? 'sí' : 'no'} · Workers: ${running}`;
          }
        } catch (err) {
          // ignore header status element — removed
        }
      }

      const btnStatusView = document.getElementById('btn-refresh-status-view');
      if (btnStatusView) btnStatusView.addEventListener('click', fetchStatus);
      // initial call
      fetchStatus();
      // periodic refresh every 10s
      setInterval(fetchStatus, 10000);
    })();
  </script>


  <!-- LLM client JS -->
  <script>
    (function () {
      const messagesEl = document.getElementById("llm-messages");
      const promptEl = document.getElementById("llm-prompt");
      const sendBtn = document.getElementById("llm-send-btn");

      // Cambia esto al host/puerto del FastAPI que expone /llm/query
      const LLM_API_BASE = "http://127.0.0.1:8000";

      if (!messagesEl || !promptEl || !sendBtn) {
        return;
      }

      function appendMessage(text, role) {
        const wrapper = document.createElement("div");
        const span = document.createElement("span");

        if (role === "user") {
          wrapper.className = "user-message";
          span.textContent = text;
        } else {
          wrapper.className = "bot-message";
          const html = window.marked ? window.marked.parse(text) : text;
          span.innerHTML = html;
        }

        wrapper.appendChild(span);
        messagesEl.appendChild(wrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function sendPrompt() {
        const prompt = promptEl.value.trim();
        if (!prompt) {
          return;
        }

        appendMessage("Tú: " + prompt, "user");
        promptEl.value = "";
        sendBtn.disabled = true;

        try {
          const response = await fetch(LLM_API_BASE + "/llm/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: prompt })
          });

          const data = await response.json();
          appendMessage(data.response || "[Respuesta vacía]", "bot");
        } catch (err) {
          appendMessage("Error llamando al LLM: " + err, "bot");
        } finally {
          sendBtn.disabled = false;
          promptEl.focus();
        }
      }

      sendBtn.addEventListener("click", sendPrompt);
      promptEl.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendPrompt();
        }
      });
    })();
  </script>
</body>

</html>