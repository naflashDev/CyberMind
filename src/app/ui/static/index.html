<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>CYBERMIND</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 220px;
      background: #111827;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 16px;
      box-sizing: border-box;
      transition: width 0.2s ease, transform 0.2s ease;
    }

    .sidebar.hidden {
      width: 0;
      padding: 16px 0;
      transform: translateX(-100%);
    }

    .sidebar h1 {
      font-size: 18px;
      margin: 0 0 16px;
      color: #f9fafb;
      white-space: nowrap;
    }

    .nav-button {
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: none;
      background: #1f2937;
      color: inherit;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
      white-space: nowrap;
    }

    .nav-button:hover {
      background: #374151;
    }

    .nav-button.active {
      background: #2563eb;
      color: #f9fafb;
    }

    /* Toggle button (always visible) */
    .toggle-wrapper {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      background: #111827;
    }

    .toggle-sidebar {
      background: #111827;
      color: #e5e7eb;
      border: none;
      padding: 8px 6px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 0 4px 4px 0;
    }

    .main {
      flex: 1;
      background: #f3f4f6;
      display: flex;
      flex-direction: column;
    }

    .main-content {
      flex: 1;
      padding: 0;
      overflow: hidden;
      position: relative;
    }

    .view {
      width: 100%;
      height: 100%;
      display: none;
    }

    .view.active {
      display: block;
    }


    .embed-frame {
      width: 100%;
      height: 100%;
      border: none;
      background: #ffffff;
    }

    /* LLM console styles: full-size */
    #view-llm {
      background: #0d1117;
      color: #e6edf3;
      padding: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    #llm-panel {
      margin: 0;
      width: 100%;
      height: 100%;
      background-color: #161b22;
      border-radius: 0;
      border: 1px solid #30363d;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    #llm-panel h2 {
      margin: 0 0 4px 0;
      font-size: 18px;
    }

    #llm-panel p {
      margin: 0 0 12px 0;
      font-size: 13px;
      color: #ffffff;
    }

    #llm-messages {
      flex: 1;
      height: auto;
      overflow-y: auto;
      padding: 8px;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #36465f;
      font-size: 13px;
      line-height: 1.4;
      box-sizing: border-box;
    }

    #llm-input-row {
      display: flex;
      margin-top: 10px;
      gap: 8px;
    }

    #llm-prompt {
      flex: 1;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #555;
      background-color: #101010;
      color: #f1f1f1;
    }

    #llm-prompt::placeholder {
      color: #6e7681;
    }

    #llm-send-btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      background: #238636;
      color: #fff;
      cursor: pointer;
    }

    #llm-send-btn:hover {
      background: #2ea043;
    }

    /* Chat bubbles */
    .user-message {
      text-align: right;
      margin-bottom: 4px;
      font-size: 15px;
    }

    .user-message span {
      display: inline-block;
      background: #1d4ed8;
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .bot-message {
      text-align: left;
      margin-bottom: 8px;
    }

    .bot-message span {
      display: inline-block;
      background: #3a548a;
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }

    /* Controllers pane (FastAPI) - dark theme */
    .controllers-pane {
      width: 280px;
      background: #0b1220; /* dark background */
      color: #e6eef8;
      border-right: 1px solid #111827;
      padding: 12px;
      box-sizing: border-box;
      overflow: auto;
    }

    .controllers-pane h3 {
      margin-top: 0;
      color: #e6eef8;
    }

    .controller-section {
      margin-bottom: 8px;
      border-radius: 6px;
      overflow: hidden;
      background: transparent;
    }

    .controller-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: transparent;
      color: #dbeafe;
      font-weight: 600;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }

    .controller-header .toggle-icon {
      font-size: 12px;
      color: #9ca3af;
      margin-left: 8px;
    }

    .ops-container {
      margin-top: 6px;
      display: block;
    }

    .controller-section.collapsed .ops-container {
      display: none;
    }

    .op-btn {
      display: block;
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
      color: #e6eef8;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
    }

    .op-btn:hover {
      background: rgba(255,255,255,0.04);
    }

    .op-btn.active {
      background: #2563eb; /* blue highlight */
      color: #f8fafc;
      border-color: rgba(37,99,235,0.8);
    }

  </style>

  <!-- Markdown parser (marked) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- [web:67] -->
</head>

<body>
  <!-- Botón fijo para mostrar/ocultar la sidebar -->
  <div class="toggle-wrapper">
    <button class="toggle-sidebar" id="btn-toggle">&laquo;</button>
  </div>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <h1>CyberMind</h1>
    <button class="nav-button active" data-view="fastapi" id="btn-fastapi">Operaciones FastAPI</button>
    <button class="nav-button" data-view="datos" id="btn-datos">Datos</button>
    <button class="nav-button" data-view="tiny" id="btn-tiny">Noticias Tiny</button>
    <button class="nav-button" data-view="llm" id="btn-llm">CyberSentinel IA</button>

  </aside>

  <!-- MAIN -->
  <div class="main">
    <div class="main-content">
      <!-- Vista: FastAPI - Operaciones de los controllers -->
      <div class="view active" id="view-fastapi">
        <div style="display:flex; height:100%;">
          <!-- Left: controllers list inside the fastapi view -->
          <div class="controllers-pane">
            <h3>Controllers</h3>
            <div id="controllers-list"></div>
          </div>

          <!-- Right: operation form and result -->
          <div style="flex:1; padding:12px; box-sizing:border-box; display:flex; flex-direction:column;">
            <div style="margin-bottom:8px; display:flex; align-items:center; justify-content:space-between;">
              <h3 id="op-title" style="margin:0;">Seleccione una operación</h3>
              <div style="font-size:13px; color:#6b7280;">FastAPI API: <code>http://127.0.0.1:8000</code></div>
            </div>

            <div id="op-form" style="margin-bottom:12px;">
              <p style="color:#6b7280;">Seleccione una operación en la izquierda para ver los parámetros y ejecutarla.</p>
            </div>

            <div style="flex:1; overflow:auto;">
              <pre id="op-result" style="background:#0b1220; color:#e6eef8; padding:12px; border-radius:6px; white-space:pre-wrap;">Respuesta aquí...</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista: Datos (OpenSearch en localhost:5601) -->
      <div class="view" id="view-datos">
        <iframe class="embed-frame" src="http://127.0.0.1:5601/"></iframe>
      </div>

      <!-- Vista: Noticias Tiny (Tiny RSS en 127.0.0.1:8280/tt-rss/) -->
      <div class="view" id="view-tiny">
        <iframe class="embed-frame" src="http://127.0.0.1:8280/tt-rss/"></iframe>
      </div>

      <!-- Vista LLM full-size -->
      <div class="view" id="view-llm">
        <div id="llm-panel">
          <h2>LLM Console (Cyberintelligence)</h2>
          <p>Interactúa con el modelo local (llama3 en Ollama) para consultar CVE y noticias procesadas.</p>

          <div id="llm-messages"></div>

          <div id="llm-input-row">
            <input id="llm-prompt" type="text"
              placeholder="Escribe tu pregunta al LLM (por ejemplo, explica un CVE o resume una noticia)..." />
            <button id="llm-send-btn">Enviar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const btnToggle = document.getElementById("btn-toggle");

    const buttons = document.querySelectorAll(".nav-button");
    const views = {
      fastapi: document.getElementById("view-fastapi"),
      datos: document.getElementById("view-datos"),
      tiny: document.getElementById("view-tiny"),
      llm: document.getElementById("view-llm"),
    };

    function activateView(viewName) {
      // desactiva todos los botones
      buttons.forEach(btn => btn.classList.remove("active"));
      // activa el botón correspondiente
      const activeBtn = document.querySelector(`.nav-button[data-view="${viewName}"]`);
      if (activeBtn) activeBtn.classList.add("active");

      // oculta todas las vistas
      Object.values(views).forEach(v => v.classList.remove("active"));
      // muestra solo la seleccionada
      if (views[viewName]) views[viewName].classList.add("active");
    }

    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        const view = btn.dataset.view;
        activateView(view);
      });
    });

    btnToggle.addEventListener("click", () => {
      const hidden = sidebar.classList.toggle("hidden");
      btnToggle.innerHTML = hidden ? "☰" : "«";
    });

    // vista inicial
    activateView("fastapi");
  </script>

  <!-- FastAPI operations panel script -->
  <script>
    (function () {
      const API_BASE = window.__CYBERMIND_API_BASE__ || "http://127.0.0.1:8000";

      // Known controller operations (hardcoded from server routes)
      const controllers = {
        "Scrapy": [
          { id: "scrape-news", title: "Scrape News", method: "GET", path: "/newsSpider/scrape-news", params: [] },
          { id: "start-google-alerts", title: "Start Google Alerts", method: "GET", path: "/newsSpider/start-google-alerts", params: [] },
          { id: "save-feed-google-alerts", title: "Save Feed Google Alerts", method: "POST", path: "/newsSpider/save-feed-google-alerts", params: [{name: "link", type: "text", placeholder: "URL o texto del feed"}] },
          { id: "scrapy-google-dk-feeds", title: "Scrapy Google DK Feeds", method: "GET", path: "/newsSpider/scrapy/google-dk/feeds", params: [] },
          { id: "scrapy-google-dk-news", title: "Scrapy Google DK News", method: "GET", path: "/newsSpider/scrapy/google-dk/news", params: [] }
        ],
        "SpaCy": [
          { id: "start-spacy", title: "Start SpaCy", method: "GET", path: "/start-spacy", params: [] }
        ],
        "Tiny": [
          { id: "search-and-insert-rss", title: "Search and Insert RSS", method: "GET", path: "/postgre-ttrss/search-and-insert-rss", params: [{name: "q", type: "text", placeholder: "consulta (opcional)"}] },
          { id: "feeds", title: "List Feeds", method: "GET", path: "/postgre-ttrss/feeds", params: [] }
        ]
      };

      const controllersList = document.getElementById("controllers-list");
      const opTitle = document.getElementById("op-title");
      const opForm = document.getElementById("op-form");
      const opResult = document.getElementById("op-result");

      function renderControllers() {
        controllersList.innerHTML = "";
        Object.keys(controllers).forEach(name => {
          const wrapper = document.createElement("div");
          wrapper.className = "controller-section";

          // header with collapse toggle
          const headerBtn = document.createElement("button");
          headerBtn.className = "controller-header";
          headerBtn.type = "button";
          headerBtn.innerHTML = `<span>${name}</span><span class="toggle-icon">▾</span>`;
          headerBtn.addEventListener("click", () => {
            wrapper.classList.toggle("collapsed");
            const icon = headerBtn.querySelector('.toggle-icon');
            if (icon) icon.textContent = wrapper.classList.contains('collapsed') ? '▸' : '▾';
          });
          wrapper.appendChild(headerBtn);

          const opsContainer = document.createElement("div");
          opsContainer.className = "ops-container";

          controllers[name].forEach(op => {
            const opBtn = document.createElement("button");
            opBtn.className = "op-btn";
            opBtn.textContent = op.title;
            opBtn.type = "button";
            opBtn.addEventListener("click", () => {
              // set active visual state for buttons
              document.querySelectorAll('.op-btn').forEach(b => b.classList.remove('active'));
              opBtn.classList.add('active');
              selectOperation(name, op, opBtn);
            });
            opsContainer.appendChild(opBtn);
          });

          wrapper.appendChild(opsContainer);
          controllersList.appendChild(wrapper);
        });
      }

      function selectOperation(controllerName, op, btnEl) {
        opTitle.textContent = controllerName + " — " + op.title + " (" + op.method + ")";
        renderForm(op);
        opResult.textContent = "Respuesta aquí...";
      }

      function renderForm(op) {
        opForm.innerHTML = "";
        const info = document.createElement("div");
        info.style.marginBottom = "8px";
        info.style.color = "#cbd5e1";
        info.innerHTML = `<strong>${op.path}</strong> — ${op.method}`;
        opForm.appendChild(info);

        const form = document.createElement("form");
        form.onsubmit = async (e) => {
          e.preventDefault();
          await submitOperation(op, new FormData(form));
        };

        // params
        if (op.params && op.params.length) {
          op.params.forEach(p => {
            const label = document.createElement("label");
            label.style.display = "block";
            label.style.marginBottom = "6px";
            label.innerHTML = `<div style='font-size:13px;color:#cbd5e1;margin-bottom:4px;'>${p.name}</div>`;

            const input = document.createElement("input");
            input.name = p.name;
            input.placeholder = p.placeholder || "";
            input.style.width = "100%";
            input.style.padding = "8px";
            input.style.boxSizing = "border-box";
            input.style.marginBottom = "6px";
            label.appendChild(input);
            form.appendChild(label);
          });
        }

        const submit = document.createElement("button");
        submit.textContent = "Ejecutar";
        submit.type = "submit";
        submit.className = "exec-btn";
        submit.style.padding = "8px 12px";
        submit.style.background = "#2563eb";
        submit.style.color = "#fff";
        submit.style.border = "none";
        submit.style.borderRadius = "6px";
        submit.style.cursor = "pointer";

        form.appendChild(submit);
        opForm.appendChild(form);
      }

      async function submitOperation(op, formData) {
        const url = API_BASE + op.path;
        opResult.textContent = "Cargando...";

        try {
          let resp;
          if (op.method === "GET") {
            // append query params
            const params = new URLSearchParams();
            for (const [k, v] of formData.entries()) if (v) params.append(k, v);
            const final = params.toString() ? url + "?" + params.toString() : url;
            resp = await fetch(final);
          } else {
            const obj = {};
            for (const [k, v] of formData.entries()) obj[k] = v;
            resp = await fetch(url, {
              method: op.method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(obj)
            });
          }

          const text = await resp.text();
          // try parse json
          try {
            const j = JSON.parse(text);
            opResult.textContent = JSON.stringify(j, null, 2);
          } catch (e) {
            opResult.textContent = text;
          }
        } catch (err) {
          opResult.textContent = "Error: " + err;
        }
      }

      // initial render
      renderControllers();
    })();
  </script>


  <!-- LLM client JS -->
  <script>
    (function () {
      const messagesEl = document.getElementById("llm-messages");
      const promptEl = document.getElementById("llm-prompt");
      const sendBtn = document.getElementById("llm-send-btn");

      // Cambia esto al host/puerto del FastAPI que expone /llm/query
      const LLM_API_BASE = "http://127.0.0.1:8000";

      if (!messagesEl || !promptEl || !sendBtn) {
        return;
      }

      function appendMessage(text, role) {
        const wrapper = document.createElement("div");
        const span = document.createElement("span");

        if (role === "user") {
          wrapper.className = "user-message";
          span.textContent = text;
        } else {
          wrapper.className = "bot-message";
          const html = window.marked ? window.marked.parse(text) : text;
          span.innerHTML = html;
        }

        wrapper.appendChild(span);
        messagesEl.appendChild(wrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function sendPrompt() {
        const prompt = promptEl.value.trim();
        if (!prompt) {
          return;
        }

        appendMessage("Tú: " + prompt, "user");
        promptEl.value = "";
        sendBtn.disabled = true;

        try {
          const response = await fetch(LLM_API_BASE + "/llm/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: prompt })
          });

          const data = await response.json();
          appendMessage(data.response || "[Respuesta vacía]", "bot");
        } catch (err) {
          appendMessage("Error llamando al LLM: " + err, "bot");
        } finally {
          sendBtn.disabled = false;
          promptEl.focus();
        }
      }

      sendBtn.addEventListener("click", sendPrompt);
      promptEl.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendPrompt();
        }
      });
    })();
  </script>
</body>

</html>